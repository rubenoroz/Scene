{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/rubenoroz/scena-v1/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n// Optimized for serverless environments (Vercel + Supabase)\nconst prismaClientSingleton = () => {\n  return new PrismaClient({\n    log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : ['error'],\n    datasources: {\n      db: {\n        url: process.env.DATABASE_URL,\n      },\n    },\n  });\n};\n\ndeclare global {\n  var prisma: undefined | ReturnType<typeof prismaClientSingleton>;\n}\n\nconst prisma = globalThis.prisma ?? prismaClientSingleton();\n\nexport default prisma;\n\nif (process.env.NODE_ENV !== \"production\") globalThis.prisma = prisma;"],"names":[],"mappings":";;;;AAAA;;AAEA,4DAA4D;AAC5D,MAAM,wBAAwB;IAC5B,OAAO,IAAI,6IAAY,CAAC;QACtB,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;QAClE,aAAa;YACX,IAAI;gBACF,KAAK,QAAQ,GAAG,CAAC,YAAY;YAC/B;QACF;IACF;AACF;AAMA,MAAM,SAAS,WAAW,MAAM,IAAI;uCAErB;AAEf,wCAA2C,WAAW,MAAM,GAAG"}},
    {"offset": {"line": 139, "column": 0}, "map": {"version":3,"sources":["file:///Users/rubenoroz/scena-v1/src/lib/auth.ts"],"sourcesContent":["import NextAuth, { getServerSession, AuthOptions } from \"next-auth\"; // Import getServerSession\nimport { PrismaAdapter } from \"@auth/prisma-adapter\";\nimport GitHub from \"next-auth/providers/github\";\nimport CredentialsProvider from \"next-auth/providers/credentials\";\nimport bcrypt from \"bcryptjs\";\nimport prisma from \"@/lib/prisma\"; // Import the singleton Prisma client\n\n// This is your auth configuration\nexport const authOptions: AuthOptions = {\n  adapter: PrismaAdapter(prisma),\n  providers: [\n    GitHub({\n      clientId: process.env.GITHUB_ID ?? \"\",\n      clientSecret: process.env.GITHUB_SECRET ?? \"\",\n    }),\n    CredentialsProvider({\n      name: \"Credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"text\" },\n        password: { label: \"Password\", type: \"password\" },\n      },\n      async authorize(credentials, req) {\n        if (!credentials?.email || !credentials?.password) {\n          return null;\n        }\n\n        const user = await prisma.user.findUnique({\n          where: {\n            email: credentials.email,\n          },\n        });\n\n        if (!user || !user.hashedPassword) {\n          return null;\n        }\n\n        const isValid = await bcrypt.compare(\n          credentials.password,\n          user.hashedPassword\n        );\n\n        if (isValid) {\n          return user;\n        }\n\n        return null;\n      },\n    }),\n  ],\n  session: {\n    strategy: \"jwt\",\n  },\n  callbacks: {\n    async jwt({ token, user }) {\n      console.log(\"JWT Callback - Token:\", token);\n      console.log(\"JWT Callback - User:\", user);\n      if (user) {\n        token.id = user.id;\n        token.role = user.role; // Assign role from the user object\n      }\n\n      // If the user's role is SUPERADMIN, set isSuperAdmin to true\n      token.isSuperAdmin = token.role === \"SUPERADMIN\";\n\n      return token;\n    },\n    async session({ session, token }) {\n      console.log(\"Session Callback - Session:\", session);\n      console.log(\"Session Callback - Token:\", token);\n      if (session.user) {\n        session.user.id = token.id as string;\n        session.user.role = token.role; // Assign role from the token\n        session.user.isSuperAdmin = token.isSuperAdmin; // Assign isSuperAdmin from the token\n      }\n      return session;\n    },\n    async redirect({ url, baseUrl }) {\n      // Redirect to dashboard after successful login\n      if (url.startsWith(baseUrl)) {\n        return url;\n      }\n      // Default redirect to dashboard\n      return `${baseUrl}/dashboard`;\n    },\n  },\n  pages: {\n    signIn: '/login', // Specify your sign-in page\n  },\n  secret: process.env.NEXTAUTH_SECRET,\n  debug: process.env.NODE_ENV === 'development',\n};\n\n// This is the handler for the [...nextauth] route\n// It's used by app/api/auth/[...nextauth]/route.ts\nexport const { handlers } = NextAuth(authOptions);\n\n// This is the server-side auth helper for NextAuth.js v4 in App Router\nexport async function auth() {\n  return getServerSession(authOptions);\n}\n"],"names":[],"mappings":";;;;;;;;AAAA,6OAAqE,0BAA0B;AAC/F;AACA;AACA;AACA;AACA,8MAAmC,qCAAqC;;;;;;;AAGjE,MAAM,cAA2B;IACtC,SAAS,IAAA,uKAAa,EAAC,iIAAM;IAC7B,WAAW;QACT,IAAA,gKAAM,EAAC;YACL,UAAU,QAAQ,GAAG,CAAC,SAAS,IAAI;YACnC,cAAc,QAAQ,GAAG,CAAC,aAAa,IAAI;QAC7C;QACA,IAAA,qKAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAO;gBACtC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW,EAAE,GAAG;gBAC9B,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU;oBACjD,OAAO;gBACT;gBAEA,MAAM,OAAO,MAAM,iIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBACxC,OAAO;wBACL,OAAO,YAAY,KAAK;oBAC1B;gBACF;gBAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,cAAc,EAAE;oBACjC,OAAO;gBACT;gBAEA,MAAM,UAAU,MAAM,8IAAM,CAAC,OAAO,CAClC,YAAY,QAAQ,EACpB,KAAK,cAAc;gBAGrB,IAAI,SAAS;oBACX,OAAO;gBACT;gBAEA,OAAO;YACT;QACF;KACD;IACD,SAAS;QACP,UAAU;IACZ;IACA,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,QAAQ,GAAG,CAAC,yBAAyB;YACrC,QAAQ,GAAG,CAAC,wBAAwB;YACpC,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,IAAI,GAAG,KAAK,IAAI,EAAE,mCAAmC;YAC7D;YAEA,6DAA6D;YAC7D,MAAM,YAAY,GAAG,MAAM,IAAI,KAAK;YAEpC,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,QAAQ,GAAG,CAAC,+BAA+B;YAC3C,QAAQ,GAAG,CAAC,6BAA6B;YACzC,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;gBAC1B,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI,EAAE,6BAA6B;gBAC7D,QAAQ,IAAI,CAAC,YAAY,GAAG,MAAM,YAAY,EAAE,qCAAqC;YACvF;YACA,OAAO;QACT;QACA,MAAM,UAAS,EAAE,GAAG,EAAE,OAAO,EAAE;YAC7B,+CAA+C;YAC/C,IAAI,IAAI,UAAU,CAAC,UAAU;gBAC3B,OAAO;YACT;YACA,gCAAgC;YAChC,OAAO,GAAG,QAAQ,UAAU,CAAC;QAC/B;IACF;IACA,OAAO;QACL,QAAQ;IACV;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe;IACnC,OAAO,oDAAyB;AAClC;AAIO,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,kJAAQ,EAAC;AAG9B,eAAe;IACpB,OAAO,IAAA,2JAAgB,EAAC;AAC1B"}},
    {"offset": {"line": 246, "column": 0}, "map": {"version":3,"sources":["file:///Users/rubenoroz/scena-v1/src/lib/permissions.ts"],"sourcesContent":["export const ROLES = {\n    ADMIN: 'ADMIN',\n    PROJECT_MANAGER: 'PROJECT_MANAGER',\n    ARTIST: 'ARTIST',\n    VIEWER: 'VIEWER',\n} as const;\n\nexport type Role = keyof typeof ROLES;\n\nexport const PERMISSIONS = {\n    // Workspace\n    MANAGE_WORKSPACE: ['ADMIN'],\n    CREATE_PROJECT: ['ADMIN', 'PROJECT_MANAGER'],\n    DELETE_PROJECT: ['ADMIN'],\n\n    // Project\n    MANAGE_PROJECT: ['ADMIN', 'PROJECT_MANAGER'],\n    VIEW_PROJECT: ['ADMIN', 'PROJECT_MANAGER', 'ARTIST', 'VIEWER'],\n    MANAGE_ROLES: ['ADMIN', 'PROJECT_MANAGER'],\n\n    // Tasks\n    CREATE_TASK: ['ADMIN', 'PROJECT_MANAGER'],\n    EDIT_ANY_TASK: ['ADMIN', 'PROJECT_MANAGER'],\n    EDIT_OWN_TASK: ['ADMIN', 'PROJECT_MANAGER', 'ARTIST'],\n    MOVE_OWN_TASK: ['ADMIN', 'PROJECT_MANAGER', 'ARTIST'], // Artists can move their own tasks\n    DELETE_TASK: ['ADMIN', 'PROJECT_MANAGER'],\n    ASSIGN_TASK: ['ADMIN', 'PROJECT_MANAGER'],\n\n    // Comments\n    ADD_COMMENT: ['ADMIN', 'PROJECT_MANAGER', 'ARTIST'],\n    DELETE_ANY_COMMENT: ['ADMIN', 'PROJECT_MANAGER'],\n    DELETE_OWN_COMMENT: ['ADMIN', 'PROJECT_MANAGER', 'ARTIST'],\n\n    // Files\n    UPLOAD_FILE: ['ADMIN', 'PROJECT_MANAGER', 'ARTIST'],\n    DELETE_FILE: ['ADMIN', 'PROJECT_MANAGER'],\n} as const;\n\nexport function hasPermission(userRole: string, allowedRoles: readonly string[]): boolean {\n    return allowedRoles.includes(userRole);\n}\n\nimport prisma from \"@/lib/prisma\";\n\nexport async function getUserRoleInProject(userId: string, projectId: string): Promise<string> {\n    // 1. Check direct project role\n    const projectUser = await prisma.projectUser.findUnique({\n        where: {\n            projectId_userId: {\n                projectId,\n                userId,\n            },\n        },\n    });\n\n    if (projectUser) return projectUser.role;\n\n    // 2. Check workspace role (if implemented, workspace admins might have access to all projects)\n    // For now, we'll assume project-level roles are primary. \n    // But we should check if the user is a workspace admin.\n\n    const project = await prisma.project.findUnique({\n        where: { id: projectId },\n        select: { workspaceId: true },\n    });\n\n    if (project) {\n        const workspaceUser = await prisma.workspaceUser.findUnique({\n            where: {\n                workspaceId_userId: {\n                    workspaceId: project.workspaceId,\n                    userId,\n                },\n            },\n        });\n\n        if (workspaceUser && workspaceUser.role === ROLES.ADMIN) {\n            return ROLES.ADMIN;\n        }\n    }\n\n    // Default fallback (e.g., if user is owner of project)\n    const projectOwner = await prisma.project.findUnique({\n        where: { id: projectId },\n        select: { ownerId: true },\n    });\n\n    if (projectOwner && projectOwner.ownerId === userId) {\n        return ROLES.ADMIN;\n    }\n\n    return ROLES.VIEWER; // Default role if found but no specific role assigned? Or maybe null?\n    // For safety, let's return a restricted role or handle \"not found\"\n}\n"],"names":[],"mappings":";;;;;;;;;;AA0CA;AA1CO,MAAM,QAAQ;IACjB,OAAO;IACP,iBAAiB;IACjB,QAAQ;IACR,QAAQ;AACZ;AAIO,MAAM,cAAc;IACvB,YAAY;IACZ,kBAAkB;QAAC;KAAQ;IAC3B,gBAAgB;QAAC;QAAS;KAAkB;IAC5C,gBAAgB;QAAC;KAAQ;IAEzB,UAAU;IACV,gBAAgB;QAAC;QAAS;KAAkB;IAC5C,cAAc;QAAC;QAAS;QAAmB;QAAU;KAAS;IAC9D,cAAc;QAAC;QAAS;KAAkB;IAE1C,QAAQ;IACR,aAAa;QAAC;QAAS;KAAkB;IACzC,eAAe;QAAC;QAAS;KAAkB;IAC3C,eAAe;QAAC;QAAS;QAAmB;KAAS;IACrD,eAAe;QAAC;QAAS;QAAmB;KAAS;IACrD,aAAa;QAAC;QAAS;KAAkB;IACzC,aAAa;QAAC;QAAS;KAAkB;IAEzC,WAAW;IACX,aAAa;QAAC;QAAS;QAAmB;KAAS;IACnD,oBAAoB;QAAC;QAAS;KAAkB;IAChD,oBAAoB;QAAC;QAAS;QAAmB;KAAS;IAE1D,QAAQ;IACR,aAAa;QAAC;QAAS;QAAmB;KAAS;IACnD,aAAa;QAAC;QAAS;KAAkB;AAC7C;AAEO,SAAS,cAAc,QAAgB,EAAE,YAA+B;IAC3E,OAAO,aAAa,QAAQ,CAAC;AACjC;;AAIO,eAAe,qBAAqB,MAAc,EAAE,SAAiB;IACxE,+BAA+B;IAC/B,MAAM,cAAc,MAAM,iIAAM,CAAC,WAAW,CAAC,UAAU,CAAC;QACpD,OAAO;YACH,kBAAkB;gBACd;gBACA;YACJ;QACJ;IACJ;IAEA,IAAI,aAAa,OAAO,YAAY,IAAI;IAExC,+FAA+F;IAC/F,0DAA0D;IAC1D,wDAAwD;IAExD,MAAM,UAAU,MAAM,iIAAM,CAAC,OAAO,CAAC,UAAU,CAAC;QAC5C,OAAO;YAAE,IAAI;QAAU;QACvB,QAAQ;YAAE,aAAa;QAAK;IAChC;IAEA,IAAI,SAAS;QACT,MAAM,gBAAgB,MAAM,iIAAM,CAAC,aAAa,CAAC,UAAU,CAAC;YACxD,OAAO;gBACH,oBAAoB;oBAChB,aAAa,QAAQ,WAAW;oBAChC;gBACJ;YACJ;QACJ;QAEA,IAAI,iBAAiB,cAAc,IAAI,KAAK,MAAM,KAAK,EAAE;YACrD,OAAO,MAAM,KAAK;QACtB;IACJ;IAEA,uDAAuD;IACvD,MAAM,eAAe,MAAM,iIAAM,CAAC,OAAO,CAAC,UAAU,CAAC;QACjD,OAAO;YAAE,IAAI;QAAU;QACvB,QAAQ;YAAE,SAAS;QAAK;IAC5B;IAEA,IAAI,gBAAgB,aAAa,OAAO,KAAK,QAAQ;QACjD,OAAO,MAAM,KAAK;IACtB;IAEA,OAAO,MAAM,MAAM,EAAE,sEAAsE;AAC3F,mEAAmE;AACvE"}},
    {"offset": {"line": 401, "column": 0}, "map": {"version":3,"sources":["file:///Users/rubenoroz/scena-v1/src/app/api/projects/%5BprojectId%5D/tasks/%5BtaskId%5D/duplicate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport prisma from \"@/lib/prisma\";\nimport { auth } from \"@/lib/auth\";\nimport { getUserRoleInProject, hasPermission, PERMISSIONS } from \"@/lib/permissions\";\n\n// POST /api/projects/[projectId]/tasks/[taskId]/duplicate\nexport async function POST(\n    req: NextRequest,\n    { params }: { params: Promise<{ projectId: string; taskId: string }> }\n) {\n    try {\n        const session = await auth();\n        if (!session?.user?.id) {\n            return NextResponse.json({ message: \"Unauthorized\" }, { status: 401 });\n        }\n\n        const { projectId, taskId } = await params;\n\n        // Check permissions - only admins and project managers can duplicate\n        const userRole = await getUserRoleInProject(session.user.id, projectId);\n        if (!hasPermission(userRole, PERMISSIONS.MANAGE_PROJECT)) {\n            return NextResponse.json({ message: \"Forbidden\" }, { status: 403 });\n        }\n\n        // Recursive function to duplicate task and all its subtasks\n        async function duplicateTaskRecursive(\n            originalTaskId: string,\n            newParentId: string | null = null\n        ): Promise<string> {\n            // Get original task with all its data\n            const originalTask = await prisma.task.findUnique({\n                where: { id: originalTaskId },\n                include: {\n                    children: true,\n                },\n            });\n\n            if (!originalTask) {\n                throw new Error(\"Task not found\");\n            }\n\n            // Create duplicate task\n            const duplicateTask = await prisma.task.create({\n                data: {\n                    title: newParentId === null ? `${originalTask.title} (Copy)` : originalTask.title,\n                    description: originalTask.description,\n                    projectId: originalTask.projectId,\n                    columnId: originalTask.columnId,\n                    parentId: newParentId,\n                    order: originalTask.order,\n                    priority: originalTask.priority,\n                    tags: originalTask.tags,\n                    links: originalTask.links,\n                    checklist: originalTask.checklist,\n                    color: originalTask.color,\n                    // Don't copy: assignees, dates, attachments, images, progress\n                },\n            });\n\n            // Recursively duplicate all children\n            for (const child of originalTask.children) {\n                await duplicateTaskRecursive(child.id, duplicateTask.id);\n            }\n\n            return duplicateTask.id;\n        }\n\n        // Start duplication\n        const newTaskId = await duplicateTaskRecursive(taskId);\n\n        return NextResponse.json({ id: newTaskId }, { status: 201 });\n    } catch (error) {\n        console.error(\"Error duplicating task:\", error);\n        return NextResponse.json(\n            { message: \"Error duplicating task\" },\n            { status: 500 }\n        );\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAGO,eAAe,KAClB,GAAgB,EAChB,EAAE,MAAM,EAA8D;IAEtE,IAAI;QACA,MAAM,UAAU,MAAM,IAAA,4HAAI;QAC1B,IAAI,CAAC,SAAS,MAAM,IAAI;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,MAAM,EAAE,SAAS,EAAE,MAAM,EAAE,GAAG,MAAM;QAEpC,qEAAqE;QACrE,MAAM,WAAW,MAAM,IAAA,mJAAoB,EAAC,QAAQ,IAAI,CAAC,EAAE,EAAE;QAC7D,IAAI,CAAC,IAAA,4IAAa,EAAC,UAAU,0IAAW,CAAC,cAAc,GAAG;YACtD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;YAAY,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,4DAA4D;QAC5D,eAAe,uBACX,cAAsB,EACtB,cAA6B,IAAI;YAEjC,sCAAsC;YACtC,MAAM,eAAe,MAAM,iIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;gBAC9C,OAAO;oBAAE,IAAI;gBAAe;gBAC5B,SAAS;oBACL,UAAU;gBACd;YACJ;YAEA,IAAI,CAAC,cAAc;gBACf,MAAM,IAAI,MAAM;YACpB;YAEA,wBAAwB;YACxB,MAAM,gBAAgB,MAAM,iIAAM,CAAC,IAAI,CAAC,MAAM,CAAC;gBAC3C,MAAM;oBACF,OAAO,gBAAgB,OAAO,GAAG,aAAa,KAAK,CAAC,OAAO,CAAC,GAAG,aAAa,KAAK;oBACjF,aAAa,aAAa,WAAW;oBACrC,WAAW,aAAa,SAAS;oBACjC,UAAU,aAAa,QAAQ;oBAC/B,UAAU;oBACV,OAAO,aAAa,KAAK;oBACzB,UAAU,aAAa,QAAQ;oBAC/B,MAAM,aAAa,IAAI;oBACvB,OAAO,aAAa,KAAK;oBACzB,WAAW,aAAa,SAAS;oBACjC,OAAO,aAAa,KAAK;gBAE7B;YACJ;YAEA,qCAAqC;YACrC,KAAK,MAAM,SAAS,aAAa,QAAQ,CAAE;gBACvC,MAAM,uBAAuB,MAAM,EAAE,EAAE,cAAc,EAAE;YAC3D;YAEA,OAAO,cAAc,EAAE;QAC3B;QAEA,oBAAoB;QACpB,MAAM,YAAY,MAAM,uBAAuB;QAE/C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;QAAU,GAAG;YAAE,QAAQ;QAAI;IAC9D,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,SAAS;QAAyB,GACpC;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}